#!/bin/bash

source bin/set-vars

echo "Start RabbitMQ server (version ${RMQ_VERSION}) for Integration Tests"

if [ ! -d "${RJMS_RABBITMQ_BASE}" ] ; then
  sudo ./bin/util/getRabbitVersion ${RMQ_VERSION}
  if [ ! -d "${RJMS_RABBITMQ_BASE}" ] ; then
    echo "Couldn't find, nor build the RJMS_RABBITMQ_BASE directory"
    exit 1
  fi
fi

if [ ! -a "${RJMS_RABBITMQ_BASE}/etc/rabbitmq/rabbitmq.config" ] ; then
  if [ -a "/opt/vmware/rabbitmq_config/rabbitmq.config" ] ; then
    echo 'rabbitmq.config will be copied into rabbitmq_server/etc/rabbitmq'
    sudo cp /opt/vmware/rabbitmq_config/rabbitmq.config ${RJMS_RABBITMQ_BASE}/etc/rabbitmq/rabbitmq.config
  fi
fi

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} stop || echo 'not stopped'

echo 'Delete previous logs:'
sudo rm -rf ${RJMS_RABBITMQ_BASE}/var/log/rabbitmq/*
echo '-------------------------'
echo 'Delete previous mnesia db:'
sudo rm -rf ${RJMS_RABBITMQ_BASE}/var/lib/mnesia/*
echo '-------------------------'

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins disable rabbitmq_jms_topic_exchange
sudo rm ${RJMS_RABBITMQ_PLUGINS}/rjms-topic-selector-*.ez
sudo cp target/plugins/rjms-topic-selector-*.ez ${RJMS_RABBITMQ_PLUGINS}/.
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins enable rabbitmq_jms_topic_exchange

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins list

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-server >target/${RJMS_RABBITMQ_NODENAME}.conslog 2>&1 &

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} wait ${RJMS_RABBITMQ_BASE}/var/lib/rabbitmq/mnesia/${RJMS_RABBITMQ_NODENAME}.pid

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} stop_app
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} reset
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} start_app
