#!/bin/bash

echo 'Start RabbitMQ server for Integration Tests'

if [ -z "${RJMS_RABBITMQ_BASE}" ] ; then
  echo "Couldn't find the RJMS_RABBITMQ_BASE directory"
  exit 1
fi

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} stop || echo 'not stopped'

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins disable rabbitmq_jms_topic_exchange
sudo rm ${RJMS_RABBITMQ_PLUGINS}/rjms-topic-selector-*.ez
sudo cp target/plugins/rjms-topic-selector-*.ez ${RJMS_RABBITMQ_PLUGINS}/.
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins enable rabbitmq_jms_topic_exchange

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-plugins list

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmq-server >target/${RJMS_RABBITMQ_NODENAME}.conslog 2>&1 &

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} wait ${RJMS_RABBITMQ_BASE}/var/lib/rabbitmq/mnesia/${RJMS_RABBITMQ_NODENAME}.pid

sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} stop_app
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} reset
sudo ${RJMS_RABBITMQ_BASE}/sbin/rabbitmqctl -n ${RJMS_RABBITMQ_NODENAME} start_app
